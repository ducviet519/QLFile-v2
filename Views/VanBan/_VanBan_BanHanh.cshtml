@using WebTools.Models.ViewModel
<style>
    .fieldset {
        position: relative;
        border: 1px solid #ddd;
        padding: 10px;
    }

        .fieldset h1 {
            position: absolute;
            top: 0;
            font-size: 14px;
            line-height: 1;
            margin: -9px 0 0; /* half of font-size */
            background: #fff;
            padding: 0 3px;
        }

    #tbVanBanBanHanh tbody tr.selected {
        color: unset !important;
        background-color: unset !important;
    }

    #sendMail {
        display: none;
    }

    .col-125 {
        width: 125px;
        padding-left: 7.5px;
        padding-right: 7.5px;
    }

    #modalPhatHanhVanBan select:invalid + .select2-container > span.selection > span.select2-selection {
        border-color: #dc3545;
    }

    #modalPhatHanhVanBan select:invalid + .select2-container--focus > span.selection > span.select2-selection {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    #modalPhatHanhVanBan select:valid + .select2-container > span.selection > span.select2-selection {
        border-color: #28a745;
    }

    #modalPhatHanhVanBan select:valid + .select2-container--focus > span.selection > span.select2-selection {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
</style>
@await Html.PartialAsync("Shared/_StyleUI_ComboBox")
<!-- Modal -->
<div class="modal fade bd-example-modal-xl" id="modalPhatHanhVanBan" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"><i class="fas fa-shipping-fast"></i> Phát hành văn bản</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="col-12">
                    <div class="col pl-0">
                        <label class="label-checkbox"><input type="checkbox" id="customControlAutosizing" name="customControlAutosizing" />Gửi mail phát hành văn bản</label>
                    </div>
                    <form id="frmSendEmail">
                        <div class="" id="sendMail">
                            <div class="form-group row col-12">
                                <label class="col-form-label col-125">Email người gửi: </label>
                                <div class="col">
                                    <div class="row">
                                        <div class="col">
                                            <input type="email" class="form-control" id="emailAccount" name="emailAccount" placeholder="Tài khoản" autocomplete="off" required>
                                        </div>
                                        <div class="col">
                                            <input type="password" class="form-control" id="emailPassword" name="emailPassword" placeholder="Mật khẩu" autocomplete="off" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row col-12">
                                <label class="col-form-label col-125">Email người nhận: </label>
                                <div class="col">
                                    <select class="form-control" id="ToEmail" name="ToEmail" multiple="multiple" required></select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <table id="tbVanBanBanHanh" class="table table-bordered table-striped" width="100%">
                    <thead class="thead">
                        <tr>
                            <th></th>
                            <th>Tên VB</th>
                            <th>Mã VB</th>
                            <th>Ngày BH</th>
                            <th>Ngày HL</th>
                            <th>Khoa phòng</th>
                            <th>Đối tượng</th>
                            <th>Nội dung</th>
                        </tr>
                    </thead>
                </table>
                <input type="hidden" id="jsonData" value="@ViewBag.JsonData" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-save="phathanhvanban"><i class="fas fa-save"></i> Phát hành</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fas fa-times"></i> Đóng</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $('#ToEmail').select2({ tags: true, width: "100%" });

        $('#customControlAutosizing').change(function () {
            $('#sendMail').toggle();
        });

        var data = jQuery.parseJSON(document.getElementById('jsonData').value);

        var columnData = [
            { "data": "ID" },
            { "data": "TenVanBan" },
            { "data": "MaVanBan" },
            { "data": "NgayBanHanh" },
            { "data": "NgayHieuLuc" },
            { "data": "KPApDung" },
            { "data": "DoiTuongApDung" },
            {
                "data": { NoiDung: "NoiDung" },
                "render": function (data, type, full, meta) {
                    return '<input type="text" class="form-control" id="NoiDung-' + meta.row + '" name="NoiDung-' + meta.row + '" value="' + data.NoiDung + '">';
                },
            },
        ];

        var table = $("#tbVanBanBanHanh").DataTable({
            "scrollY": '50vh',
            "scrollX": true,
            "paging": false,
            "fixedHeader": true,
            "lengthChange": false,
            "data": data,
            "columns": columnData,
            "columnDefs": [
                { "orderable": false, "targets": 'no-order' },
                { "className": "text-nowrap", "targets": "_all" },
                { "defaultContent": '', "targets": "_all" },
                { "targets": 0, "checkboxes": { "selectRow": true } }
            ],
            "select": {
                "style": "multi",
                "selector": '.dt-checkboxes'
            },
            "language": {
                "sProcessing": "Đang tải dữ liệu...",
                "sLengthMenu": "Xem _MENU_ mục",
                "sZeroRecords": "Không tìm thấy dòng nào phù hợp",
                "sInfo": "Đang xem _START_ đến _END_ trong tổng số _TOTAL_ mục",
                "sInfoEmpty": "Đang xem 0 đến 0 trong tổng số 0 mục",
                "sInfoFiltered": "(được lọc từ _MAX_ mục)",
                "sInfoPostFix": "",
                "sSearch": "Tìm:",
                "sUrl": "",
                "oPaginate": {
                    "sFirst": "Đầu",
                    "sPrevious": "Trước",
                    "sNext": "Tiếp",
                    "sLast": "Cuối"
                }
            },
            'initComplete': function (settings) {
                var api = this.api();

                api.cells(
                    api.rows(function (idx, data, node) {
                        return (data[0] !== '') ? true : false;
                    }).indexes(),
                    0
                ).checkboxes.select();
            },
        });

        function getData(dataToSend) {
            var result = null;
            $.ajax({
                url: '/Mail/MailTemplate',
                type: "POST",
                contentType: 'application/json; charset=UTF-8',
                data: dataToSend,
                dataType: 'html',
                async: false,
                success: function (data) {
                    result = data;
                }
            });
            return result;
        }

        $('body #modalPhatHanhVanBan').on('click', 'button[data-save="phathanhvanban"]', function (e) {
            var rows = table.rows({ selected: true }).data();

            if (rows.length > 0) {
                var listID = new Array();
                var listVanBan = new Array();
                $.each(rows, function (index, value) {
                    var id = {};
                    id.IDVanBan = value.ID;
                    id.IDPhienBan = value.IDPhienBan;
                    listID.push(id);
                    var vanban = {};
                    vanban.ID = value.ID;
                    vanban.IDPhienBan = value.IDPhienBan;
                    vanban.TenVanBan = value.TenVanBan;
                    vanban.MaVanBan = value.MaVanBan;
                    vanban.NgayBanHanh = value.NgayBanHanh;
                    vanban.NgayHieuLuc = value.NgayHieuLuc;
                    vanban.KPApDung = value.KPApDung;
                    vanban.DoiTuongApDung = value.DoiTuongApDung;
                    vanban.NoiDung = ((document.getElementById("NoiDung-" + index) || {}).value) || "";
                    listVanBan.push(vanban);
                });
                var vanbanData = JSON.stringify({ 'listID': listID });
                if ($('#customControlAutosizing').is(':checked')) {
                    var form = $("#frmSendEmail")
                    if (form[0].checkValidity() === true) {
                        var toEmail = $('#ToEmail').val();
                        var htmldata = getData(JSON.stringify(listVanBan));
                        var mailAccount = ((document.getElementById("emailAccount") || {}).value) || "";
                        var mailPassword = ((document.getElementById("emailPassword") || {}).value) || "";
                        var dataToSend = JSON.stringify({ 'emailBody': htmldata, 'emailAccount': mailAccount, 'emailPassword': mailPassword, 'listEmail': toEmail });

                        $.ajax({
                            type: 'POST',
                            url: '/VanBan/SendEmailBanHanh',
                            contentType: 'application/json; charset=UTF-8',
                            data: dataToSend,
                            dataType: "json",
                            beforeSend: function () {
                                $('button[data-save="phathanhvanban"]').attr("disabled", true);
                            },
                            success: function (data) {
                                $(this).callToast(data.result, data.title, data.message);
                                if (data.result === "success") {
                                    SendAjax('/VanBan/BanHanhVanBanUpsert', vanbanData);
                                }
                                
                            },
                            error: function (data) {
                                $(this).callToast(data.result, data.title, data.message);
                            },
                            complete: function () {
                                $('button[data-save="phathanhvanban"]').attr("disabled", false);
                            },
                        });
                    }
                    else {
                        event.preventDefault()
                        event.stopPropagation()
                        form.addClass('was-validated');
                    }
                }
                else {
                    SendAjax('/VanBan/BanHanhVanBanUpsert', vanbanData);
                }                
            }
            else {
                Swal.fire(
                    'Bạn chưa chọn văn bản nào!',
                    'Chọn văn bản trước khi phát hành văn bản',
                    'warning'
                )
            }
            e.preventDefault();
        });

        function SendAjax(url, dataToSend) {
            $.ajax({
                type: 'POST',
                url: url,
                contentType: 'application/json; charset=UTF-8',
                data: dataToSend,
                dataType: "json",
                beforeSend: function () {
                    $('button[data-save="phathanhvanban"]').attr("disabled", true);
                },
                success: function (data) {
                    $(this).callToast(data.result, data.title, data.message);
                },
                error: function (data) {
                    $(this).callToast(data.result, data.title, data.message);
                },
                complete: function () {
                    $('button[data-save="phathanhvanban"]').attr("disabled", false);
                },
            });
        }        

        $('#modalPhatHanhVanBan').on('shown.bs.modal', function (e) {
            $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
        });
    });
</script>
